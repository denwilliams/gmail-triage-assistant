{{define "history"}}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Email History - Gmail Triage Assistant</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
</head>
<body>
	{{template "nav" .}}
	<main class="container">
		<article>
			<h2>üìß Email Processing History</h2>
			<p>Review AI decisions for recently processed emails (last 50).</p>
		</article>

		{{if .Emails}}
			{{range .Emails}}
			<article style="margin-bottom: 1.5rem; border-left: 3px solid #0066cc; padding-left: 1rem;">
				<h4 style="margin-bottom: 0.5rem;">
					{{.Subject}}
					{{if .BypassedInbox}}
					<span style="display: inline-block; background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 4px; margin-left: 8px; font-size: 0.85em;">Archived</span>
					{{end}}
				</h4>
				<p style="color: #666; margin: 0.25rem 0;">
					<small>From: <strong>{{.FromAddress}}</strong> | Slug: <code>{{.Slug}}</code></small>
				</p>
				<p style="margin: 0.5rem 0;"><strong>Summary:</strong> {{.Summary}}</p>
				<p style="margin: 0.5rem 0;">
					<strong>Keywords:</strong>
					{{range .Keywords}}
					<code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; margin: 2px; font-size: 0.85em;">{{.}}</code>
					{{end}}
				</p>
				<p style="margin: 0.5rem 0;">
					<strong>Labels Applied:</strong>
					{{if .LabelsApplied}}
						{{range .LabelsApplied}}
						<span style="display: inline-block; background: #0066cc; color: white; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.85em;">{{.}}</span>
						{{end}}
					{{else}}
						<em style="color: #666;">No labels</em>
					{{end}}
				</p>
				{{if .Reasoning}}
				<p style="margin: 0.5rem 0; color: #555; font-style: italic; border-top: 1px solid #eee; padding-top: 0.5rem;">
					<small><strong>AI Reasoning:</strong> {{.Reasoning}}</small>
				</p>
				{{end}}

				<!-- Human Feedback Section -->
				<details style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 0.5rem;">
					<summary style="cursor: pointer; color: #0066cc; font-weight: 600;">
						{{if .HumanFeedback}}
							‚úèÔ∏è Edit Feedback
						{{else}}
							üí≠ Add Feedback: "Do differently next time..."
						{{end}}
					</summary>
					<form action="/history/feedback" method="POST" style="margin-top: 0.5rem;">
						<input type="hidden" name="email_id" value="{{.ID}}">
						<textarea
							name="feedback"
							rows="3"
							placeholder="Describe what should be done differently for similar emails..."
							style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em;">{{.HumanFeedback}}</textarea>
						<div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
							<button type="submit" style="padding: 0.4rem 1rem; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
								{{if .HumanFeedback}}Update{{else}}Save{{end}} Feedback
							</button>
							{{if .HumanFeedback}}
							<button type="submit" onclick="this.form.feedback.value=''" style="padding: 0.4rem 1rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
								Clear
							</button>
							{{end}}
						</div>
					</form>
					{{if .HumanFeedback}}
					<p style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-left: 3px solid #ffc107; font-size: 0.85em;">
						<strong>Current feedback:</strong> {{.HumanFeedback}}
					</p>
					{{end}}
				</details>

				<p style="color: #888; margin: 0.25rem 0;">
					<small>Processed: {{.ProcessedAt.Format "Jan 2, 2006 3:04 PM"}}</small>
				</p>
			</article>
			{{end}}
		{{else}}
			<article>
				<p><em>No emails processed yet. Send yourself an email to see it appear here!</em></p>
			</article>
		{{end}}
	</main>
</body>
</html>
{{end}}
